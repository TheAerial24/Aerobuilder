// Wait for the page to load before running scripts
document.addEventListener('DOMContentLoaded', () => {

    // --- 1. Get all the HTML elements we need ---
    const sliders = document.querySelectorAll('input[type="range"]');
    const pointsRemainingEl = document.getElementById('points-remaining');
    const testFlightBtn = document.getElementById('test-flight-btn');
    const flightReportEl = document.getElementById('flight-report');
    
    // NEW: Mission selector
    const missionSelectEl = document.getElementById('mission-select');

    // Get value display elements
    const wingsValEl = document.getElementById('wings-val');
    const engineValEl = document.getElementById('engine-val');
    const fuelValEl = document.getElementById('fuel-val');
    const bodyValEl = document.getElementById('body-val');

    const TOTAL_POINTS = 100;

    // --- 2. Update Points Function ---
    function updatePoints() {
        // Get the current value of all sliders
        let pointsUsed = 0;
        sliders.forEach(slider => {
            pointsUsed += parseInt(slider.value);
        });

        const pointsLeft = TOTAL_POINTS - pointsUsed;
        pointsRemainingEl.textContent = pointsLeft;

        // Update individual value spans
        wingsValEl.textContent = document.getElementById('wings').value;
        engineValEl.textContent = document.getElementById('engine').value;
        fuelValEl.textContent = document.getElementById('fuel').value;
        bodyValEl.textContent = document.getElementById('body').value;

        // Check if user has gone over or under the limit
        if (pointsLeft < 0) {
            pointsRemainingEl.style.color = 'red';
            testFlightBtn.disabled = true; // Disable button if over budget
            testFlightBtn.textContent = "You are over budget!";
        } else {
            pointsRemainingEl.style.color = '#333';
            testFlightBtn.disabled = false;
            testFlightBtn.textContent = "Test Flight!";
        }
    }

    // --- 3. Add Event Listeners to Sliders ---
    // When any slider moves, run the updatePoints function
    sliders.forEach(slider => {
        slider.addEventListener('input', updatePoints);
    });

    // --- 4. Test Flight Logic (HEAVILY UPDATED) ---
    testFlightBtn.addEventListener('click', () => {
        // Get final values
        const wings = parseInt(document.getElementById('wings').value);
        const engine = parseInt(document.getElementById('engine').value);
        const fuel = parseInt(document.getElementById('fuel').value);
        const body = parseInt(document.getElementById('body').value);
        
        // Get the selected mission
        const selectedMission = missionSelectEl.value;

        // --- Simple Physics Simulation ---
        let lift = wings * 1.5;
        let thrust = engine * 1.5;
        let weight = (engine * 0.5) + (fuel * 0.8) + (body * 0.5) + (wings * 0.2);
        let drag = (wings * 0.5) + (body * 0.5);
        let fuelBurn = engine * 0.1; // Lower is better
        
        // --- Performance Stats (calculated only if flight is possible) ---
        let speed = (thrust - drag) * 5;
        let range = (fuelBurn > 0) ? (fuel / fuelBurn * 100) : 0; // Avoid divide by zero
        let strength = (body - (weight * 0.1));
        let isSturdy = (strength >= 10);

        // --- Generate Flight Report ---
        let report = ""; // Start with an empty report
        let flightSucceeded = false;

        // Check 1: Takeoff (Lift vs Weight)
        if (lift < weight) {
            report += '<p class="report-fail">FLIGHT FAILURE!</p>';
            report += '<p>Your plane is too heavy for its wings! It could not get off the ground.</p>';
        }
        // Check 2: Stall (Thrust vs Drag)
        else if (thrust < drag) {
            report += '<p class="report-fail">FLIGHT FAILURE!</p>';
            report += '<p>Your engines are too weak! The plane stalled and crashed due to excessive drag.</p>';
        }
        // Check 3: Success!
        else {
            flightSucceeded = true;
            report += '<p class="report-success">FLIGHT SUCCESS!</p>';
            report += `<p>Your design is airworthy. Here are the flight stats:</p>`;
            report += '<ul>';
            report += `<li><strong>Max Speed:</strong> ${speed.toFixed(0)} mph</li>`;
            report += `<li><strong>Max Range:</strong> ${range.toFixed(0)} miles</li>`;
            report += `<li><strong>Airframe:</strong> ${isSturdy ? 'Sturdy' : 'Flimsy'}</li>`;
            report += '</ul>';
        }

        // --- Check Mission Status (Only if flight succeeded) ---
        if (flightSucceeded && selectedMission !== 'none') {
            let missionReport = "";
            let missionSuccess = false;

            switch (selectedMission) {
                case 'short-hauler':
                    if (range >= 500) missionSuccess = true;
                    missionReport = missionSuccess ? 
                        `MISSION SUCCESS: You met the 500-mile range goal!` :
                        `MISSION FAILED: Your range was only ${range.toFixed(0)} miles.`;
                    break;
                case 'long-hauler':
                    if (range >= 3000) missionSuccess = true;
                    missionReport = missionSuccess ? 
                        `MISSION SUCCESS: You met the 3,000-mile range goal!` :
                        `MISSION FAILED: Your range was only ${range.toFixed(0)} miles.`;
                    break;
                case 'speed-demon':
                    if (speed >= 500) missionSuccess = true;
                    missionReport = missionSuccess ? 
                        `MISSION SUCCESS: You met the 500 mph speed goal!` :
                        `MISSION FAILED: Your speed was only ${speed.toFixed(0)} mph.`;
                    break;
                case 'heavy-lifter':
                    if (isSturdy) missionSuccess = true;
                    missionReport = missionSuccess ? 
                        `MISSION SUCCESS: Your airframe was Sturdy!` :
                        `MISSION FAILED: Your airframe was Flimsy.`;
                    break;
            }
            
            // Add mission report to the main report
            if (missionSuccess) {
                report += `<p class="mission-success">${missionReport}</p>`;
            } else {
                report += `<p class="mission-fail">${missionReport}</p>`;
            }
        }
        
        // Display the final report
        flightReportEl.innerHTML = report;
    });

    // --- 5. Initial Call ---
    // Run updatePoints once on page load to set initial values
    updatePoints();
});
